/**
 * Title Pattern Analyzer
 * ----------------------
 * usage:
 *   pnpm ts-node src/scripts/diagnostics/analyzeTitlePatterns.ts kariraku
 */

import { initializeApp, applicationDefault } from "firebase-admin/app";
import { getFirestore } from "firebase-admin/firestore";
import { openai } from "../../lib/infra/openai.js"; // プロジェクト構成に合わせて調整
import type { ChatCompletion } from "openai";

initializeApp({ credential: applicationDefault() });

const db = getFirestore();

async function main() {
  const siteId = process.argv[2];
  if (!siteId) {
    console.error("Usage: analyzeTitlePatterns <siteId>");
    process.exit(1);
  }

  console.log("=== Analyze Title Patterns ===");
  console.log("siteId:", siteId);

  // 1. blogs の最新 200 件を取得（published だけ）
  const snap = await db
    .collection("blogs")
    .where("siteId", "==", siteId)
    .where("status", "==", "published")
    .orderBy("publishedAt", "desc")
    .limit(200)
    .get();

  const blogs = snap.docs.map((d) => ({
    id: d.id,
    title: d.get("title") ?? "",
    primaryKeywordDocId: d.get("primaryKeywordDocId") ?? null,
    primaryKeyword: d.get("primaryKeyword") ?? "",
    views: d.get("views") ?? 0,
  }));

  if (blogs.length === 0) {
    console.log("No blogs found.");
    return;
  }

  console.log(`Fetched blogs: ${blogs.length}`);

  // 2. siteKeywords を取得して score / clicks を参照
  const kwSnap = await db
    .collection("siteKeywords")
    .where("siteId", "==", siteId)
    .get();

  const keywords: Record<
    string,
    { keyword: string; score: number; clickRate: number }
  > = {};

  kwSnap.forEach((d) => {
    const raw = d.data();
    keywords[d.id] = {
      keyword: raw.keyword ?? "",
      score: raw.score ?? 0,
      clickRate: raw.clickRate ?? 0,
    };
  });

  // 3. キーワードごとに「代表タイトル」をランキング
  const joined = blogs.map((b) => {
    const kw = b.primaryKeywordDocId ? keywords[b.primaryKeywordDocId] : null;
    return {
      title: b.title,
      keyword: b.primaryKeyword,
      kwScore: kw?.score ?? 0,
      kwClickRate: kw?.clickRate ?? 0,
      views: b.views,
    };
  });

  // CTR や views、keyword score を複合評価
  const ranked = joined
    .map((x) => ({
      ...x,
      composite:
        x.kwScore * 0.5 + x.kwClickRate * 0.3 + Math.log(x.views + 2) * 0.2,
    }))
    .sort((a, b) => b.composite - a.composite);

  // 上位 20 件だけ AI に渡す
  const topTitles = ranked.slice(0, 20).map((x) => ({
    title: x.title,
    keyword: x.keyword,
    score: x.composite,
  }));

  console.log("Top titles for analysis:");
  console.log(topTitles);

  // 4. OpenAI に「タイトルの型」抽出を依頼
  const prompt = `
以下は、サイト「${siteId}」で最近よく読まれている（CTR やスコアが高い）記事タイトルです。
これらのタイトルが共通して持っている「パターン」「型」「構造」を抽出し、
今後タイトルを生成する際に使える明確なルールとして JSON 形式でまとめてください。

【高評価タイトル例】
${topTitles.map((t) => `- (${t.score.toFixed(2)}) ${t.title}`).join("\n")}

【求める JSON 構造】
{
  "patterns": [
    {
      "name": "やさしい気持ちに寄り添う型",
      "description": "読者の不安や生活のモヤモヤに共感しながら、静かに解決方向を示す",
      "rules": [
        "具体的な生活シーンを短く含める",
        "断定しない（〜するといいかも、〜がラクになった話）",
        "比較語を入れすぎない"
      ],
      "example": "在宅ワークで肩がしんどいときに、少しラクになった工夫"
    }
  ],
  "keywordHints": [
    {
      "keyword": "在宅ワーク",
      "effectiveWords": ["肩こり", "小さな工夫", "整える", "ラクになる"]
    }
  ],
  "globalStyle": {
    "tone": "落ち着いた、静か、寄り添う",
    "avoid": ["断定表現", "強調しすぎる語"]
  }
}

曖昧にではなく、必ず上記の構造で出力してください。
`;

  const completion = (await openai.chat.completions.create({
    model: "gpt-4o-mini",
    temperature: 0.4,
    messages: [
      {
        role: "system",
        content: "You are an assistant that extracts stylistic patterns.",
      },
      { role: "user", content: prompt },
    ],
  })) as ChatCompletion;

  const text = completion.choices[0].message?.content ?? "{}";

  let json: any = {};
  try {
    json = JSON.parse(text);
  } catch (e) {
    console.error("Failed to parse JSON from OpenAI:", text);
    throw e;
  }

  // Firestore に保存
  await db.collection("sites").doc(siteId).set(
    {
      titlePatterns: json,
      titlePatternsUpdatedAt: Date.now(),
    },
    { merge: true }
  );

  console.log("Saved titlePatterns for site:", siteId);
  console.log(JSON.stringify(json, null, 2));
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
